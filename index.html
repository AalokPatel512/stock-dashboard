<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Options Chart Dashboard</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js "></script>
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #161a23;
      --card-bg: #1e2230;
      --accent-blue: #6366f1;
      --accent-pink: #ec4899;
      --text-primary: #ffffff;
      --text-secondary: #a3a3a3;
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 20%);
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    h1 {
      font-size: 2rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 24px;
      background: linear-gradient(90deg, #6366f1, #ec4899);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 24px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .tab {
      background-color: var(--bg-secondary);
      border: 1px solid #2d3242;
      color: var(--text-secondary);
      padding: 10px 20px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: var(--transition);
    }
    .tab:hover,
    .tab.active {
      background-color: var(--accent-blue);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    .tab.active {
      font-weight: 600;
    }
    /* Control Bar */
    .control-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
      background-color: var(--card-bg);
      padding: 18px;
      border-radius: var(--border-radius);
      border: 1px solid #2d3242;
      margin-bottom: 24px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    .dropdown-group {
      display: flex;
      flex-direction: column;
      min-width: 180px;
      position: relative;
    }
    .dropdown-group label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    #symbolSearch {
      padding: 10px;
      background-color: #252a38;
      color: var(--text-primary);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      width: 100%;
      outline: none;
      cursor: pointer;
    }
    #symbolDropdown {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background-color: #1e2230;
      border: 1px solid #2d3242;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 10;
    }
    #symbolDropdown.show {
      display: block;
    }
    #symbolDropdown div {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #2d3242;
    }
    #symbolDropdown div:hover {
      background-color: #2a303f;
    }
    .price {
      text-align: center;
      font-size: 14px;
    }
    .price div {
      margin: 4px 0;
    }
    .green {
      color: #4ade80;
      font-weight: 500;
    }
    .red {
      color: #f87171;
      font-weight: 500;
    }
    .refresh-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .refresh-toggle label {
      color: var(--text-secondary);
    }
    .refresh-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-blue);
      cursor: pointer;
    }
    .auto-refresh-dropdown {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .auto-refresh-dropdown select {
      padding: 8px;
      background-color: #252a38;
      color: var(--text-primary);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      cursor: pointer;
    }
    /* Chart Container */
    .chart-container {
      background-color: var(--card-bg);
      border: 1px solid #2d3242;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
      border-radius: 8px;
    }
    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      font-size: 14px;
      margin-top: 10px;
    }
    .legend .put {
      color: #ec4899;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .legend .call {
      color: #6366f1;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .legend span::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .legend .put::before {
      background-color: #ec4899;
    }
    .legend .call::before {
      background-color: #6366f1;
    }
    @media (max-width: 768px) {
      .control-bar {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Options Chart</h1>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="open-interest">Open Interest</button>
      <button class="tab" data-tab="change-in-oi">Change in OI</button>
      <button class="tab" data-tab="put-call-ratio">Put Call Ratio</button>
      <button class="tab" data-tab="volume-pcr">Volume PCR</button>
      <button class="tab" data-tab="live-max-pain">Live Max Pain</button>
    </div>

    <!-- Control Bar -->
    <div class="control-bar">
      <!-- Searchable Stock Dropdown -->
      <div class="dropdown-group">
        <label for="symbolSearch">Symbol</label>
        <input type="text" id="symbolSearch" placeholder="Search stock..." autocomplete="off">
        <div id="symbolDropdown" class="symbol-dropdown"></div>
      </div>

      <!-- Price Info -->
      <div class="price">
        <div><strong>Spot Price:</strong> <span id="spotPrice" class="green">--</span></div>
        <div>Max Pain: <strong id="maxPain">--</strong></div>
        <div>Lot Size: <strong id="lotSize">--</strong></div>
      </div>

      <!-- Auto Refresh Toggle + Interval -->
      <div class="refresh-toggle">
        <label for="autoRefresh">Auto Refresh</label>
        <input type="checkbox" id="autoRefresh" checked>
      </div>
      <div class="auto-refresh-dropdown">
        <label for="refreshInterval">Every:</label>
        <select id="refreshInterval">
          <option value="5000">5s</option>
          <option value="10000">10s</option>
          <option value="30000">30s</option>
          <option value="60000">1m</option>
        </select>
      </div>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
      <canvas id="optionChart"></canvas>
    </div>

    <!-- Legend -->
    <div class="legend">
      <span class="put">PUT OI</span>
      <span class="call">CALL OI</span>
    </div>
  </div>

  <script>
    const apiKey = "GHNRC85TQW8IAYXG"; // Your Alpha Vantage API Key
    let optionChart;
    let autoRefreshInterval;

    // List of Stocks (with groups)
    const stocks = [
      { group: "Indices", options: ["NIFTY", "BANKNIFTY", "FINNIFTY"] },
      { group: "Stocks", options: [
        "SBIN", "RELIANCE", "TCS", "INFY", "HDFCBANK", "WIPRO",
        "ICICIBANK", "AXISBANK", "KOTAKBANK", "LT", "ITC", "MARUTI",
        "TATASTEEL", "BHARTIARTL", "SUNPHARMA", "ULTRACEMCO", "NESTLEIND",
        "TECHM", "BAJAJFINSV", "DIVISLAB", "DRREDDY", "EICHERMOT", "GRASIM",
        "HCLTECH", "JSWSTEEL", "ONGC", "POWERGRID", "SHREECEM", "TATAMOTORS",
        "TITAN", "BPCL", "ADANIENT", "APOLLOHOSP", "ASIANPAINT", "BRITANNIA"
      ]}
    ];

    // Lot Sizes (can be extended)
    const lotSizes = {
      SBIN: 750, RELIANCE: 500, TCS: 300, INFY: 600, HDFCBANK: 550,
      WIPRO: 3000, ICICIBANK: 2750, AXISBANK: 1200, KOTAKBANK: 800
    };

    // Current selected symbol
    let currentSymbol = "SBIN";

    // Render searchable dropdown
    function renderDropdown() {
      const dropdown = document.getElementById("symbolDropdown");
      dropdown.innerHTML = '';
      stocks.forEach(group => {
        const groupLabel = document.createElement("div");
        groupLabel.textContent = group.group;
        groupLabel.style.fontWeight = "bold";
        groupLabel.style.color = "#888";
        groupLabel.style.padding = "8px 12px";
        dropdown.appendChild(groupLabel);

        group.options.forEach(symbol => {
          const item = document.createElement("div");
          item.textContent = symbol;
          item.onclick = () => {
            currentSymbol = symbol;
            document.getElementById("symbolSearch").value = symbol;
            dropdown.classList.remove("show");
            updateStockData();
          };
          dropdown.appendChild(item);
        });
      });
    }

    // Filter dropdown on search
    document.getElementById("symbolSearch").addEventListener("input", function () {
      const value = this.value.toLowerCase();
      const items = document.querySelectorAll("#symbolDropdown > div:not(:first-child)");
      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(value) ? "" : "none";
      });
    });

    // Show/hide dropdown on focus/click
    document.getElementById("symbolSearch").addEventListener("click", function () {
      document.getElementById("symbolDropdown").classList.toggle("show");
      this.select();
    });

    // Hide dropdown on outside click
    document.addEventListener("click", function (e) {
      if (!e.target.closest('.dropdown-group')) {
        document.getElementById("symbolDropdown").classList.remove("show");
      }
    });

    // Fetch live stock price from Alpha Vantage
    async function fetchStockPrice(symbol) {
      const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}.NS&apikey=${apiKey}`;
      try {
        const response = await fetch(url);
        const data = await response.json();
        const quote = data["Global Quote"];
        if (quote) {
          return {
            price: parseFloat(quote["05. price"]),
            change: parseFloat(quote["09. change"]),
            changePercent: quote["10. change percent"]
          };
        }
      } catch (error) {
        console.error("Error fetching data:", error);
      }
      return null;
    }

    // Update Spot Price and other details
    async function updateStockData() {
      const spotPriceEl = document.getElementById("spotPrice");
      const data = await fetchStockPrice(currentSymbol);
      
      if (data) {
        const { price, change, changePercent } = data;
        spotPriceEl.textContent = `${price.toFixed(2)} ${change >= 0 ? '▲' : '▼'} (${Math.abs(change).toFixed(2)} | ${changePercent})`;
        spotPriceEl.className = change >= 0 ? "green" : "red";
        document.getElementById("maxPain").textContent = "--"; // Will add later
        document.getElementById("lotSize").textContent = lotSizes[currentSymbol] || "--";
      }

      // Re-render chart
      const activeTab = document.querySelector('.tab.active').getAttribute('data-tab');
      renderChart(activeTab);
    }

    // Generate sample OI data
    function generateSampleData(count = 9) {
      const baseStrike = Math.floor(Math.random() * 100 + 700);
      const strikes = Array.from({ length: count }, (_, i) => (baseStrike + i * 20).toString());
      const putOi = Array.from({ length: count }, () => Math.floor(Math.random() * 60 + 10));
      const callOi = Array.from({ length: count }, () => Math.floor(Math.random() * 60 + 10));
      return { strikes, putOi, callOi };
    }

    // Render Chart based on tab
    function renderChart(tab) {
      const ctx = document.getElementById('optionChart').getContext('2d');
      if (optionChart) optionChart.destroy();

      const { strikes, putOi, callOi } = generateSampleData();

      switch (tab) {
        case 'open-interest':
          optionChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: strikes,
              datasets: [
                { label: 'PUT OI', data: putOi, backgroundColor: '#ec4899', borderRadius: 6, barPercentage: 0.7 },
                { label: 'CALL OI', data: callOi, backgroundColor: '#6366f1', borderRadius: 6, barPercentage: 0.7 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { ticks: { color: '#a3a3a3' } },
                y: { ticks: { color: '#a3a3a3' } }
              }
            }
          });
          break;

        case 'change-in-oi':
          optionChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: strikes,
              datasets: [
                { label: 'PUT CHNG OI', data: putOi.map(x => x - 5), backgroundColor: '#ec4899', borderRadius: 6 },
                { label: 'CALL CHNG OI', data: callOi.map(x => x + 5), backgroundColor: '#6366f1', borderRadius: 6 }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: { ticks: { color: '#a3a3a3' } },
                y: { ticks: { color: '#a3a3a3' } }
              }
            }
          });
          break;

        case 'put-call-ratio':
        case 'volume-pcr':
        case 'live-max-pain':
          const times = ['09:15', '10:00', '10:45', '11:30', '12:15', '13:00', '14:00', '15:00'];
          const pcr = [0.8, 0.75, 0.78, 0.72, 0.70, 0.68, 0.65, 0.62];
          const spotPrices = [820, 822, 821, 824, 823, 825, 826, 824];

          optionChart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: times,
              datasets: [
                {
                  label: tab === 'live-max-pain' ? 'Max Pain' : 'PCR',
                  data: tab === 'live-max-pain' ? spotPrices.map(p => p + 10) : pcr,
                  borderColor: '#6366f1',
                  fill: false,
                  tension: 0.3
                },
                {
                  label: 'Spot Price',
                  data: spotPrices,
                  borderColor: '#ec4899',
                  fill: false,
                  tension: 0.3
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } },
              scales: {
                x: { ticks: { color: '#a3a3a3' } },
                y: { ticks: { color: '#a3a3a3' } }
              }
            }
          });
          break;
      }
    }

    // Initialize App
    function initApp() {
      renderDropdown();
      updateStockData();

      // Tab Click
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function () {
          document.querySelector('.tab.active')?.classList.remove('active');
          this.classList.add('active');
          renderChart(this.getAttribute('data-tab'));
        });
      });

      // Auto Refresh
      function startAutoRefresh() {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(updateStockData, parseInt(document.getElementById("refreshInterval").value));
      }

      document.getElementById("autoRefresh").addEventListener("change", () => {
        if (document.getElementById("autoRefresh").checked) {
          startAutoRefresh();
        } else {
          clearInterval(autoRefreshInterval);
        }
      });

      document.getElementById("refreshInterval").addEventListener("change", () => {
        if (document.getElementById("autoRefresh").checked) {
          startAutoRefresh();
        }
      });

      startAutoRefresh(); // Start initially
    }

    window.onload = initApp;
  </script>
</body>
</html>